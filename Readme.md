# koa2 weibo

author: 一抹晨曦

技术方案：
页面：先构造模板 使用 ejs 做的模板，然后去 routes 里面的 API 文件夹，做（点击、注册、点击关注....）然后 routes 里面还有一个校验(redis)然后再去 controller 构造业务逻辑，因为 routes 里面的 API 和 view 不能直接直接透过访问后层次的数据什么的，要经过 controller 处理然后在把数据传到 service 去进行数据处理，然后再去 cache（使用的 redis）缓存一下公共的信息例如广场页，然后格式化处理也是在 service 里面进行，数据库层面是使用 db 文件夹，使用的 sequelize 做定义模型，封装操作，最后 就是日志（日志包括，seq 语句的输出，正常运行的日志和错误日志）。

思维导图分层：
一、项目结构

二、错误处理

三、代码风格

四、质量保证

五、安全

六、线上环境

项目难点：
@提到我，关注和粉丝
@提到我的难点：
首先要获取粉丝的信息（包括，昵称，头像，发送的信息）,然后还要获取 @ 我的数量，再做对比，@提到我还有一个独立页面，点击进入，会显示多少条未读信息，观看之后，会变成已读
关注和粉丝难点：
要先分析用户关系，我关注了谁 他的头像昵称和我关注的个数都会显示，而且我点击到我关注人的页面，他的空间会显示他发的信息，和他关注的人，和他的粉丝和取消关注按钮，粉丝呢，也是同理，我的粉丝我点进他的空间，他的空间会显示关注了我，且看到的我的@,在代码方面用到连表查询和同步数据处理.

技术选型：

1. 框架选型： ( koa2 vs express vs egg )
   koa2 选择原因：express 是基于 js 回调，koa2 是在 express 的基础之上开发出来的框架，在里面不在使用回调形式，而是 async await 异步函数 , 为什么不用 egg 呢，因为他是一个企业开发的框架，egg 是在 koa2 的基础上比 egg 更加的繁琐，我们选用 koa2，可以自己进行编写达到 egg 的效果，所以说 koa2 是最适用于我们学习开发的。

2. 数据库选型：( mysql vs mongodb )
   Mysql 选择原因：mysql 是企业中用的最广泛的、成本最低的一个数据库系统，mongodb 没有 mysql 那么广泛，而且熟悉程度也是 mysql 也是比较高，最主要的是 mysql 是一个关系型数据库，方便做后续的连表查询。

3. 登录技术： ( session vs jwt )
   Session 选择原因: 在 webserver 中 session 要比 jwt 更加的广泛一些，jwt 更适用于前后端分离，做那这种分散形的项目，session 比较适合页面比较统一，比较集中话的 webserver。

4. 前端页面：( ejs 后端模板引擎 vs vue/recat 前端框架 )
   Ejs 选择原因： 不选择 vue/recat 的原因，第一就是因为他们本身就比较复杂，而且项目主要写 node 用 vue/react 之后 就相当于全栈开发，顾忌全局，选择后端模板引擎，第二就是用了 vue/react 之后就是前后端分离开发模式，而且 ejs 模板引擎比较简单。

5. 缓存数据库: ( redis )

6. 单元测试 ( jest )

项目总结：
项目前提，node.js 版本在 8.0 以上，先安装 koa-generator 模块，然后快速生成项目骨架的 koa 脚手架( koa2 文件名 )，然后再 npm i 初始化项目，再创建 app.js 入口文件，再做文件分层，然后下载 redis 缓存数据库，定义数据库模型,使用 redis、mysql、sequelize 建立数据连接，配置 redis 配合 node.js 使用，构造基本页面，然后使用 session 和 cookie 做配置登录要用的数据，还有加密用户信息，再然后就是注册登录还有他们的单元测试，其中包括注册登录的 api 和 controller 业务逻辑向 service 进行数据处理，然后在通过 controller 返回格式，后面就是设置页面的创建和逻辑的建立，其中包括修改密码、退出登录、修改基本信息，然后就是创建首页，先构造首页的部分数据模型，实现能够创建并发布微博，这里要定义时间函数每次发布的时间都是实时的，代码的格式校验和 xss 过滤，再就是个人主页的构建，还是一样先定义模型再创建路由，建立加载更多的 api，同时对数据库进行操作，对页面输出的数据做分页处理，再后面就是广场页，和个人空间页不同的是，要单独访问数据库，去获取所有人的信息( cache )，然后就是关注和取消关注这个需要先构建一个粉丝的模板和一个关注的模板，然后再进行逻辑处理，一般都是你关注了别人之后，上面的关注变为取消关注，没关注的就是关注 (判断关注状态)，然后再完善首页，再解决自定义逻辑问题 ( 自己关注自己 )，加入加载更多的代码逻辑，再后面就是 at 和回复实现 at 和回复功能一样要先访问数据库，要使用查询语句进行连表查询，at 提到我功能，比较繁琐，要创建模板，分析和存储 at 关系，再显示 at 的数量，再去判断你的信息是已读未读，最后就是线上环境的搭建，使用的是 pm2 工具，手动讲将代码部署到线上，不在需要 git 的终端或者其他的终端来 npm 运行，取而代之的是 pm2 start 0 或者是使用 npm 下载 pm2 模块，然后在 package,json 中配置 pm2 的运行方式，对 pm2 的运行 urL 进行配置，然后使用 npm run prd 运行项目，使用 pm2 线上运行，可以实时监控，有错误存在，还可以运行页面 ( 守护进程 )，pm2 有日志，可以快速的排错，最后就是如果想要把自己写的项目保存下来，可以使用 github/腾云等等网站，配合 git 使用，例如 github 要先去配置密钥，将 github 里面的用户名和邮箱 对应你电脑里的 git 的用户名和密码，然后就是 git 可以建立分支，不管是保存代码，还是项目杂乱想返回上一级分支都可以，最后就是提交到远程分支，保存你写的项目。

项目心得： 学习到了怎么做项目分层，怎么去命名函数，怎么去更有逻辑的去编写自己的代码，和代码的排错，还有就是可以写单元测试，每次代码分支写完之后，可以写一下单元测试，测试一下自己的逻辑、处理等等有没有错误，学会了要有耐心。

# pm2

pm2 list
pm2 restart www
pm2 stop www
pm2 delete www
pm2 info www
pm2 log www
pm2 monit www
